name: Windows-EnableIconv

on:
    push:
        branches: [ '**' ]
        paths-ignore:
            - '.github/workflows/macos.yml'
            - '.github/workflows/linux.yml'
    pull_request:
        branches: [ '**' ]
        paths-ignore:
            - '.github/workflows/macos.yml'
            - '.github/workflows/linux.yml'
    workflow_dispatch:

permissions: read-all

jobs:
    build:
        runs-on: windows-latest

        env:
            PREFIX: C:/freetds  # 修改为Windows有效路径
            ICONV_URL: https://codeload.github.com/win-iconv/win-iconv/zip
            ICONV_VER: 0.0.8

        steps:
        - uses: actions/checkout@v4
        
        - uses: ilammy/msvc-dev-cmd@v1
          
        - name: Install dependencies
          run: |
            choco install openssl --version=3.1.1 -y
            choco install gperf -y
            choco install 7zip -y

        - name: Build iconv
          shell: bash
          run: |
            curl -sSf ${ICONV_URL}/v${ICONV_VER} -o win_iconv.zip
            7z x win_iconv.zip
            mv win-iconv-${ICONV_VER} iconv
            mkdir iconv-build
            cd iconv-build
            cmake -G "NMake Makefiles" \
                  -DBUILD_STATIC=on \
                  -DBUILD_SHARED=off \
                  -DBUILD_EXECUTABLE=off \
                  -DBUILD_TEST=on \
                  -DCMAKE_BUILD_TYPE=Release \
                  ../iconv
            nmake
            cd ..

        - name: Build FreeTDS with iconv
          shell: bash
          run: |
            # 创建Windows兼容的安装目录
            mkdir -p "C:/freetds_deps/include"
            mkdir -p "C:/freetds_deps/lib"
            cp iconv/iconv.h "C:/freetds_deps/include/"
            cp iconv-build/iconv.lib "C:/freetds_deps/lib/"
            
            # 构建FreeTDS - 关键修改部分
            mkdir -p build
            cd build
            cmake -G "NMake Makefiles" \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DENABLE_MSDBLIB=on \
                  -DWITH_OPENSSL=ON \
                  -DHAVE_ICONV=1 \
                  -DICONV_INCLUDE_DIR="C:/freetds_deps/include" \
                  -DICONV_LIBRARY="C:/freetds_deps/lib/iconv.lib" \
                  -DCMAKE_INSTALL_PREFIX="$PREFIX" \
                  ..
            
            # 验证CMake配置
            cat CMakeCache.txt | grep ICONV
            
            nmake
            nmake install

        - name: Verify iconv linkage
          shell: bash
          run: |
            dumpbin /DEPENDENTS build/src/tds/tds.dll | findstr iconv
            build/src/tds/tsql -C | grep iconv

        - name: Upload Artifacts
          uses: actions/upload-artifact@v4
          with:
            name: windows-build
            path: |
              ${{ env.PREFIX }}/**/*
              ./build/**/*
